<style>
	.key {
		color: #CC0000;
	}

	.string {
		color: #007777;
	}

	.number {
		color: #AA00AA;
	}

	.boolean {
		color: #0000FF;
	}

	.null {
		color: #0000FF;
		font-weight: bold;
	}
</style>

<script type="text/javascript">
	RED.nodes.registerType('ros-service-client', {
		category: 'ROS',
		color: '#e4e9ff',
		defaults: {
			topicname: {
				value: "",
				required: true
			},
			typepackage: {
				validate: function(v) {
					return (window.list_package.indexOf(v) > -1)
				},
				required: true
			},
			typename: {
				validate: function(v) {
					return (window.list_package.indexOf(this.typepackage) > -1) && (window.list[this.typepackage].indexOf(v) > -1)
				},
				required: true
			},
			intype: {
				value: 'Request'
			}
		},
		inputs: 1,
		outputs: 1,
		paletteLabel: 'service-client',
		icon: "ros_logo.png",
		label: function() {
			return this.topicname || "ROS Service Client"
		},
		oneditprepare: function() {
			var node = this;

			if (!node.typepackage) {
				node.typepackage = 'std_msgs'
			}

			if (!node.typename) {
				node.typename = 'String'
			}

			// $('#node-input-typepackage')
			// 	.html(window.list_package_html)
			// 	.val(node.typepackage)

			// $('#node-input-typepackage').change(function() {
			// 	node.typepackage = $('#node-input-typepackage').val()
			// 	loadPackage(node.typepackage, node.typename)
			// })
			let selectedOpt = $('#node-input-configuration').val()
			buildOptionList(selectedOpt)
			$('#node-input-typepackage')
				.html(window.list_package_html)
				.val(node.typepackage)

			$('#node-input-configuration').change(function() {
				node.typepackage = $('#node-input-configuration').val()
				selectedOpt = $('#node-input-configuration').val();
			
				//load msg or svr
				buildOptionList(selectedOpt)
		
			})

			$('#node-input-typepackage').change(function(){
				console.log("HEEEEEEEEEEEEEEERE")
				const valTypepackage = $('#node-input-typepackage').val()
				console.log(valTypepackage)
				loadPackage(valTypepackage)
				
			})

			// $('#node-input-typepackage').change(function(){
			// 	node.typename = $('#node-input-typepackage').val();
			// 	setFormatText(node.typepackage + "/" + node.typename)
				
			// })
			
			loadPackage(node.typepackage, node.typename)
		},

		outputLabels: function(index) { return this.intype; }
	})

	var loadPackage = function(typepackage) {
		var ar2 = window.list[typepackage]
		console.log('ar2')
		console.log(ar2)

		// var o = ""
		// for (var i = 0; i < ar2.length; i++) {
		// 	o += '<option value="' + ar2[i] + '">' + ar2[i] + '</option>'
		// }

		// $('#node-input-typename').html(o)
		// $("#node-input-typename")
		// 	.val(typename)

		// setFormatText(typepackage + "/" + typename)
	}


var buildOptionList = function(type){
	$.getJSON(type, function(list) {
		window["list_"+type] = list
		console.log("windows")
		console.log(window["list_"+type])
		var o = ""
		var o2 = []
		for (var key in window["list_"+type].list) {
			console.log("key   ")
			console.log(key)
			// if (window["list_"+type].list.hasOwnProperty(key)) {
			o += '<option value="' + key + '">' + key + '</option>'
			o2.push(key)
			// }
		}
		
		window.list_package_html = o
		window.list_package = o2
	})
}

	// "/ROSServInfo/:package/:serviceType"
	function setFormatText(package) {
		$.getJSON('ROSInfo/' + package, function(data) {
			var v = syntaxHighlight(data)
			$('#msg_format').html(v)
		})node-input-configuration"
	}

	function syntaxHighlight(json) {
		if (typeof json != 'string') {
			json = JSON.stringify(json, undefined, 2);
		}
		json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
			var cls = 'number';
			if (/^"/.test(match)) {
				if (/:$/.test(match)) {
					cls = 'key';
				} else {
					cls = 'string';
				}
			} else if (/true|false/.test(match)) {
				cls = 'boolean';
			} else if (/null/.test(match)) {
				cls = 'null';
			}
			return '<span class="' + cls + '">' + match + '</span>';
		});
	}
</script>

<script type="text/x-red" data-template-name="ros-service-client">
	
	<div class="form-row">
		<label for="node-input-topicname">
			<i class="icon-tag"></i> ROS Topic</label>
		<input type="text" id="node-input-topicname" placeholder="/mytopic">
	</div>

	<div class="form-row">
		<label for="node-input-configuration">msg-svr</label>
        <select id="node-input-configuration">
            <option value="packages">Message</option>
            <option value="services">Service</option>
        </select>
	</div>

	<div class="form-row">
		<label for="node-input-intype">Res-Req</label>
        <select id="node-input-intype">
            <option value="req">Request</option>
            <option value="res">Response</option>
        </select>
    </div>
	
	<div class="form-row">
		<label for="node-input-typepackage">Datatype package</label>
		<select id="node-input-typepackage"></select>
	</div>

	<div class="form-row">
		<label for="node-input-typename">Datatype</label>
		<select id="node-input-typename"></select>
	</div>

	<h4>Output is given in the format:</h4>
	<pre id="msg_format">
	</pre>
</script>


<script type="text/x-red" data-help-name="ros-service-client">
	<p>A service client for a ROS service</p>
	<h3>Output</h3>
	<dl class="message-properties">
		<dt>
			payload
		</dt>
		<dd> the payload of the message subscribed</dd>
	</dl>
</script>
